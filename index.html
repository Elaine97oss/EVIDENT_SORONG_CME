<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Evident SLA CMEP & HK</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .evident-img-container {
            /* Memastikan tinggi minimal ~5cm di layar standar (192px) */
            height: 12rem; 
            min-width: 9rem;
        }
        .evident-img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Menjaga aspek rasio untuk portrait/landscape */
            border-radius: 0.5rem;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Print Specific Styles */
        @media print {
            @page {
                size: A4 portrait;
                margin: 1.5cm;
            }
            body { background-color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            /* Menyembunyikan bayangan dan border berlebih saat di print */
            .shadow-md, .shadow-sm { box-shadow: none !important; }
            /* Mencegah elemen terpotong di tengah halaman */
            .page-break-inside-avoid { page-break-inside: avoid; break-inside: avoid; }
            /* Mengubah warna teks header kategori agar terbaca saat print B/W atau warna */
            .cat-header-print { background-color: #f3f4f6 !important; color: #1f2937 !important; border-bottom: 2px solid #e5e7eb; }
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Header Screen (Sembunyi saat print) -->
    <header class="bg-red-600 text-white shadow-md sticky top-0 z-50 print:hidden">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold">Input Evident SLA Gedung</h1>
                <p class="text-xs text-red-100 mt-1">Sistem Pelaporan Evident Checklist (CMEP & HK)</p>
            </div>
            <div class="text-2xl"><i class="fas fa-building"></i></div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Header Print (Hanya muncul saat print) -->
        <div class="hidden print:block mb-8 border-b-2 border-black pb-4">
            <h2 id="print-judul" class="text-2xl font-bold text-center mb-6 uppercase tracking-wider">Laporan Evident Checklist CMEP</h2>
            <table class="font-bold text-lg">
                <tr>
                    <td class="pr-6 pb-2 uppercase">LOKASI</td>
                    <td class="pb-2 uppercase">: <span id="print-lokasi-text">GMP SORONG</span></td>
                </tr>
                <tr>
                    <td class="pr-6 uppercase">PERIODE</td>
                    <td class="uppercase">: <span id="print-periode-text">JANUARI 2026</span></td>
                </tr>
            </table>
        </div>

        <!-- Setting Laporan & Print Button (Sembunyi saat print) -->
        <div class="bg-white p-5 rounded-lg shadow border border-gray-200 mb-6 flex flex-col lg:flex-row gap-4 justify-between items-center print:hidden">
            <div class="flex flex-col sm:flex-row flex-wrap gap-4 w-full lg:w-auto">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1 text-red-600">Jenis Checklist</label>
                    <select id="input-jenis" class="w-full sm:w-48 border-gray-300 rounded focus:ring-red-500 focus:border-red-500 border px-3 py-2 text-sm font-semibold bg-red-50 text-red-800">
                        <option value="CMEP">Checklist CMEP</option>
                        <option value="HK">Checklist Housekeeping (HK)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Lokasi Gedung</label>
                    <input type="text" id="input-lokasi" value="GMP SORONG" class="w-full sm:w-48 border-gray-300 rounded focus:ring-red-500 focus:border-red-500 border px-3 py-2 text-sm uppercase">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Periode Bulan</label>
                    <select id="input-bulan" class="w-full sm:w-32 border-gray-300 rounded focus:ring-red-500 focus:border-red-500 border px-3 py-2 text-sm uppercase">
                        <option value="JANUARI">Januari</option>
                        <option value="FEBRUARI">Februari</option>
                        <option value="MARET">Maret</option>
                        <option value="APRIL">April</option>
                        <option value="MEI">Mei</option>
                        <option value="JUNI">Juni</option>
                        <option value="JULI">Juli</option>
                        <option value="AGUSTUS">Agustus</option>
                        <option value="SEPTEMBER">September</option>
                        <option value="OKTOBER">Oktober</option>
                        <option value="NOVEMBER">November</option>
                        <option value="DESEMBER">Desember</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Tahun</label>
                    <input type="number" id="input-tahun" value="2026" class="w-full sm:w-24 border-gray-300 rounded focus:ring-red-500 focus:border-red-500 border px-3 py-2 text-sm">
                </div>
            </div>
            
            <button onclick="window.print()" class="w-full lg:w-auto bg-gray-800 hover:bg-black text-white px-6 py-3 rounded-md font-bold shadow-md flex items-center justify-center gap-2 transition-colors shrink-0">
                <i class="fas fa-print"></i> Cetak PDF / Print
            </button>
        </div>

        <!-- Info Alert (Sembunyi saat print) -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded shadow-sm print:hidden">
            <div class="flex">
                <div class="flex-shrink-0"><i class="fas fa-info-circle text-blue-500"></i></div>
                <div class="ml-3">
                    <p class="text-sm text-blue-700">
                        <strong>Panduan:</strong> 
                        Pilih <strong>Jenis Checklist</strong>, Lokasi dan Periode di atas sebelum klik Cetak PDF. Evident Harian dibatasi <strong>Maksimal 20 Foto</strong> (Hari Kerja). Evident akan otomatis tersusun rapih menyesuaikan ukuran kertas A4.
                    </p>
                </div>
            </div>
        </div>

        <!-- Checklist Container (Populated by JS) -->
        <div id="checklist-container" class="space-y-6 print:space-y-4"></div>

    </main>

    <!-- Hidden Global File Input -->
    <input type="file" id="global-uploader" multiple accept="image/*" class="hidden">

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-3 rounded shadow-lg transform transition-transform duration-300 translate-y-20 opacity-0 z-50 flex items-center print:hidden">
        <i id="toast-icon" class="fas mr-2"></i>
        <span id="toast-msg" class="text-sm">Notifikasi</span>
    </div>

    <script>
        // --- 1. DATA STRUCTURE ---

        // Data Checklist CMEP
        const checklistDataCMEP = [
            {
                category: "1. Pemeliharaan Sipil & Arsitektural",
                tasks: [
                    { id: "c1-t1", name: "Pemeliharaan Dinding Tembok", freq: "1 x 6 Bulan", type: "long", period: "6 Bulan" },
                    { id: "c1-t2", name: "Pemeliharaan Dinding Kaca", freq: "1 x Sebulan", type: "short", max: 1 },
                    { id: "c1-t3", name: "Pemeliharaan Dinding Keramik", freq: "1 x Triwulan", type: "long", period: "Triwulan" },
                    { id: "c1-t4", name: "Pemeliharaan Halaman & Pagar", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "c1-t5", name: "Pemeliharaan Jendela & Pintu", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "c1-t6", name: "Pemeliharaan Lantai Karpet/Keramik/Marmer/Vynil", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "c1-t7", name: "Pemeliharaan Plafond (Semua Jenis)", freq: "Kondisional", type: "short", max: 10 }
                ]
            },
            {
                category: "2. Pemeliharaan Instalasi Sistem Plumbing",
                tasks: [
                    { id: "p1-t1", name: "Booster Pump", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "p1-t2", name: "Closet Duduk (Pelumasan)", freq: "1 x Triwulan", type: "long", period: "Triwulan" },
                    { id: "p1-t3", name: "Closet Duduk/Jongkok (Perawatan Harian)", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "p1-t4", name: "Instalasi Pipa & Kran", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "p1-t5", name: "Septik Tank / STP", freq: "Kondisional", type: "short", max: 5 }
                ]
            },
            {
                category: "3. Pemeliharaan AC & Genset",
                tasks: [
                    { id: "a1-t1", name: "Pemeliharaan AC Split / Central", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "a1-t2", name: "Genset & Panel Genset (Pemanasan)", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "a1-t3", name: "Penggantian Pelumas Genset", freq: "Kondisional", type: "short", max: 2 }
                ]
            },
            {
                category: "4. Pemeliharaan Instalasi Listrik & Fire Alarm",
                tasks: [
                    { id: "e1-t1", name: "Panel MDP/SDP, Perkabelan, Penerangan", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "e1-t2", name: "System FAP/FA/FH (Standby & Cek)", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "e1-t3", name: "Pengetesan Hydrant & Alarm Bell", freq: "1 x 6 Bulan", type: "long", period: "6 Bulan" },
                    { id: "e1-t4", name: "Uji Coba Hydrant, Sprinkler, Detector", freq: "1 x Setahun", type: "long", period: "1 Tahun" }
                ]
            }
        ];

        // Data Checklist Housekeeping (HK)
        const checklistDataHK = [
            {
                category: "1. Pembersihan Dinding Dalam",
                tasks: [
                    { id: "hk1-t1", name: "Dinding Keramik Dalam", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk1-t2", name: "Dinding Wallpaper Dalam", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk1-t3", name: "Dinding Interior Dalam", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk1-t4", name: "Dinding Kaca Interior", freq: "1 x Sehari", type: "short", max: 20 }
                ]
            },
            {
                category: "2. Pembersihan Dinding Luar",
                tasks: [
                    { id: "hk2-t1", name: "Dinding Kusen Alumunium Luar", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk2-t2", name: "Dinding Tembok Luar", freq: "1 x Sebulan", type: "short", max: 1 },
                    { id: "hk2-t3", name: "Dinding Kaca Luar", freq: "1 x Sebulan", type: "short", max: 1 }
                ]
            },
            {
                category: "3. Pembersihan Lantai",
                tasks: [
                    { id: "hk3-t1", name: "Lantai Keramik/Granit", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk3-t2", name: "Keramik Toilet", freq: "6 x Sehari", type: "short", max: 120 }, // 6x Sehari = Max 120/bulan
                    { id: "hk3-t3", name: "Lantai Vynil", freq: "4 x Sehari", type: "short", max: 80 } // 4x Sehari = Max 80/bulan
                ]
            },
            {
                category: "4. Pembersihan Plafon",
                tasks: [
                    { id: "hk4-t1", name: "Plafon Acustik", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk4-t2", name: "Plafon Gypsum", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk4-t3", name: "Plafon Defuser AC", freq: "1 x Seminggu", type: "short", max: 4 }
                ]
            },
            {
                category: "6. Pembersihan Outdoor Bangunan",
                tasks: [
                    { id: "hk6-t1", name: "Halaman Rumput", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk6-t2", name: "Sekitar Gedung", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk6-t3", name: "Jalan dengan Aspal", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk6-t4", name: "Perkerasan Aspal", freq: "By Project", type: "short", max: 10 },
                    { id: "hk6-t5", name: "Gutter", freq: "1 x Seminggu", type: "short", max: 4 }
                ]
            },
            {
                category: "7. Pengelolaan Sampah & Indoor Bangunan",
                tasks: [
                    { id: "hk7-t1", name: "Sampah di Dalam Gedung (TPS/TPA)", freq: "2 x Sehari", type: "short", max: 40 },
                    { id: "hk7-t2", name: "TV di Ruang Tamu & Kerja", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk7-t3", name: "Terminal Telepon", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk7-t4", name: "Kulkas", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk7-t5", name: "Vertical/Horizontal Blind", freq: "1 x Sebulan", type: "short", max: 1 }
                ]
            },
            {
                category: "8. Pembersihan Meubelair",
                tasks: [
                    { id: "hk8-t1", name: "Kursi Eksekutif / Rapat / Staf / Tamu / Makan", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk8-t2", name: "Meja Eksekutif / Rapat / Staf / Tamu / Makan", freq: "1 x Sehari", type: "short", max: 20 },
                    { id: "hk8-t3", name: "Lemari Rak Buku / Kredensa", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk8-t4", name: "Filling Kabinet", freq: "1 x Sehari", type: "short", max: 20 }
                ]
            },
            {
                category: "9. Pest & Rodent Control",
                tasks: [
                    { id: "hk9-t1", name: "Pengecekan Lokasi Hama", freq: "1 x Seminggu", type: "short", max: 4 },
                    { id: "hk9-t2", name: "Penyemprotan / Fogging", freq: "1 x 2 Bulan", type: "long", period: "2 Bulan" },
                    { id: "hk9-t3", name: "Pengumpanan Racun Tikus", freq: "2 x Sebulan", type: "short", max: 2 }
                ]
            },
            {
                category: "10. Hygiene Service",
                tasks: [
                    { id: "hk10-t1", name: "Pengharum Ruangan & Toilet", freq: "1 x Sebulan", type: "short", max: 2 },
                    { id: "hk10-t2", name: "Hygiene Unit", freq: "1 x Seminggu", type: "short", max: 4 }
                ]
            }
        ];

        // --- 2. STATE MANAGEMENT ---
        const taskEvidents = {}; 
        const uploadedSignatures = new Set();
        let currentTargetTaskId = null;
        let currentJenis = 'CMEP'; // Default

        // Inisialisasi state untuk SEMUA checklist agar data tidak hilang saat switch
        [...checklistDataCMEP, ...checklistDataHK].forEach(cat => {
            cat.tasks.forEach(t => { taskEvidents[t.id] = []; });
        });

        // --- 3. BIND HEADER PRINT INFO & CHECKLIST SWITCHER ---
        const inputJenis = document.getElementById('input-jenis');
        const inputLokasi = document.getElementById('input-lokasi');
        const inputBulan = document.getElementById('input-bulan');
        const inputTahun = document.getElementById('input-tahun');
        
        const printJudul = document.getElementById('print-judul');
        const printLokasi = document.getElementById('print-lokasi-text');
        const printPeriode = document.getElementById('print-periode-text');

        function updatePrintHeader() {
            currentJenis = inputJenis.value;
            printJudul.textContent = `LAPORAN EVIDENT CHECKLIST ${currentJenis}`;
            printLokasi.textContent = inputLokasi.value.toUpperCase() || '-';
            printPeriode.textContent = `${inputBulan.value.toUpperCase()} ${inputTahun.value}`;
            
            // Re-render konten checklist sesuai jenis yang dipilih
            renderApp();
        }

        inputJenis.addEventListener('change', updatePrintHeader);
        inputLokasi.addEventListener('input', updatePrintHeader);
        inputBulan.addEventListener('change', updatePrintHeader);
        inputTahun.addEventListener('input', updatePrintHeader);

        // --- 4. RENDER UI ---
        const container = document.getElementById('checklist-container');

        function renderApp() {
            container.innerHTML = '';
            
            // Pilih data berdasarkan currentJenis
            const activeData = currentJenis === 'CMEP' ? checklistDataCMEP : checklistDataHK;
            
            activeData.forEach(category => {
                const catCard = document.createElement('div');
                catCard.className = 'bg-white rounded-lg shadow-md overflow-hidden print:shadow-none print:border print:border-gray-400 print:mb-4 page-break-inside-avoid';
                
                const catHeader = document.createElement('div');
                catHeader.className = 'bg-gray-800 text-white px-6 py-3 font-semibold flex justify-between items-center cat-header-print';
                catHeader.innerHTML = `<span><i class="fas fa-folder-open mr-2 text-red-400 print:hidden"></i> ${category.category}</span>`;
                catCard.appendChild(catHeader);

                const tasksDiv = document.createElement('div');
                tasksDiv.className = 'divide-y divide-gray-200 print:divide-gray-400';

                category.tasks.forEach(task => {
                    const taskRow = document.createElement('div');
                    // Tambahkan properti khusus untuk print agar rapih (page-break-inside-avoid)
                    taskRow.className = 'p-6 print:p-4 flex flex-col md:flex-row md:items-start justify-between gap-6 hover:bg-gray-50 transition-colors page-break-inside-avoid';
                    
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'md:w-1/3 shrink-0';
                    infoDiv.innerHTML = `
                        <h3 class="font-bold text-gray-900 print:text-sm">${task.name}</h3>
                        <span class="inline-block mt-1 px-2 py-1 bg-red-100 text-red-700 text-xs rounded-full font-semibold border border-red-200 print:bg-transparent print:border-none print:px-0 print:text-gray-600">
                            <i class="far fa-clock mr-1 print:hidden"></i> Freq: ${task.freq}
                        </span>
                    `;

                    const controlDiv = document.createElement('div');
                    controlDiv.className = 'md:w-2/3 flex-1 flex flex-col w-full';
                    
                    if (task.type === 'long') {
                        controlDiv.innerHTML = renderLongPeriodControl(task);
                    } else {
                        const count = taskEvidents[task.id] ? taskEvidents[task.id].length : 0;
                        const maxStr = task.max > 0 ? task.max : '&infin;';
                        const isFull = task.max > 0 && count >= task.max;

                        controlDiv.innerHTML = `
                            <div class="flex items-center justify-between mb-3 border-b pb-2 print:hidden">
                                <span class="text-sm font-medium text-gray-600">
                                    Progress Evident: <span class="${isFull ? 'text-green-600 font-bold' : ''}">${count} / ${maxStr}</span>
                                </span>
                                <button onclick="triggerUpload('${task.id}')" 
                                        ${isFull ? 'disabled' : ''}
                                        class="${isFull ? 'bg-gray-300 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700 active:bg-red-800'} text-white px-4 py-2 rounded-md text-sm font-medium transition-colors shadow-sm flex items-center">
                                    <i class="fas fa-camera mr-2"></i> Tambah Foto
                                </button>
                            </div>
                            <!-- Saat print flex-wrap agar gambar turun jika melebihi kertas -->
                            <div class="flex gap-4 overflow-x-auto pb-2 items-center print:overflow-visible print:flex-wrap print:pt-2" id="gallery-${task.id}">
                                ${count === 0 ? '<p class="text-sm text-gray-400 italic py-4 print:text-xs">Belum ada evident/Tidak dikerjakan.</p>' : renderGallery(task.id)}
                            </div>
                        `;
                    }

                    taskRow.appendChild(infoDiv);
                    taskRow.appendChild(controlDiv);
                    tasksDiv.appendChild(taskRow);
                });

                catCard.appendChild(tasksDiv);
                container.appendChild(catCard);
            });

            bindLongPeriodEvents(activeData);
        }

        function renderLongPeriodControl(task) {
            const currentStatus = taskEvidents[task.id].status || ''; 
            const currentMonth = taskEvidents[task.id].month || '';
            const hasImage = taskEvidents[task.id].image;

            return `
                <div class="bg-gray-100 p-4 rounded-md border border-gray-200 print:bg-white print:p-0 print:border-none">
                    
                    <!-- Dropdown Controls (Sembunyi saat print) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3 print:hidden">
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Status Pekerjaan (${task.period})</label>
                            <select id="status-${task.id}" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:border-red-500 focus:ring-red-500 py-2 px-3 border bg-white">
                                <option value="" ${!currentStatus ? 'selected' : ''}>-- Pilih Status --</option>
                                <option value="sudah" ${currentStatus === 'sudah' ? 'selected' : ''}>Pekerjaan Sudah Dilaksanakan</option>
                                <option value="akan" ${currentStatus === 'akan' ? 'selected' : ''}>Pekerjaan Akan Dilaksanakan</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-600 mb-1 uppercase tracking-wider">Bulan & Tahun (2026)</label>
                            <div class="flex gap-2">
                                <select id="month-${task.id}" class="flex-1 text-sm border-gray-300 rounded-md shadow-sm focus:border-red-500 focus:ring-red-500 py-2 px-3 border bg-white">
                                    <option value="">Pilih Bulan</option>
                                    ${['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'].map(m => 
                                        `<option value="${m}" ${currentMonth === m ? 'selected' : ''}>${m}</option>`
                                    ).join('')}
                                </select>
                                <span class="py-2 px-3 bg-gray-200 rounded-md text-sm border text-gray-700 font-bold">2026</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Text Preview (Akan Tampil saat Print & Screen) -->
                    <div class="bg-white print:bg-gray-50 p-3 rounded text-sm text-gray-700 italic border mb-3 min-h-[42px] flex items-center shadow-inner print:shadow-none print:font-semibold" id="text-preview-${task.id}">
                        ${currentStatus && currentMonth ? `Pekerjaan ${currentStatus} dilaksanakan di Bulan ${currentMonth} 2026` : 'Pekerjaan belum dikonfirmasi statusnya.'}
                    </div>

                    <!-- Upload Zone -->
                    <div id="upload-zone-${task.id}" class="${currentStatus === 'sudah' ? 'block' : 'hidden'} border-t print:border-none pt-3 mt-2 border-gray-200">
                        ${hasImage 
                            ? `<div class="relative inline-block evident-img-container shadow-sm border p-1 bg-white rounded">
                                 <img src="${hasImage.dataUrl}" class="evident-img">
                                 <button onclick="removeLongPeriodImage('${task.id}', '${hasImage.signature}')" class="absolute -top-2 -right-2 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow hover:bg-red-700 border-2 border-white cursor-pointer print:hidden"><i class="fas fa-times"></i></button>
                               </div>`
                            : `<button onclick="triggerUpload('${task.id}', true)" class="w-full bg-white border-2 border-dashed border-gray-300 text-gray-600 px-4 py-4 rounded-md text-sm font-medium hover:bg-gray-50 hover:border-red-400 transition-colors flex items-center justify-center gap-2 print:hidden">
                                    <i class="fas fa-upload text-xl text-gray-400"></i>
                                    <span>Upload Evident Pendukung</span>
                               </button>`
                        }
                    </div>
                </div>
            `;
        }

        function renderGallery(taskId) {
            return taskEvidents[taskId].map((ev, index) => `
                <!-- Tambahkan print:mb-2 agar saat membungkus ke bawah ada jarak -->
                <div class="relative shrink-0 evident-img-container shadow-sm border border-gray-200 p-1 bg-white rounded group print:border-gray-400 print:shadow-none print:mb-2">
                    <img src="${ev.dataUrl}" alt="Evident" class="evident-img print:rounded-none">
                    <div class="absolute bottom-1 right-1 bg-black bg-opacity-60 text-white text-[10px] px-1.5 py-0.5 rounded backdrop-blur-sm print:hidden">
                        ${index + 1}
                    </div>
                    <button onclick="removeEvident('${taskId}', ${index}, '${ev.signature}')" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs shadow-md border-2 border-white hover:bg-red-700 hover:scale-110 transition-transform cursor-pointer print:hidden">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function bindLongPeriodEvents(activeData) {
            activeData.forEach(cat => cat.tasks.forEach(task => {
                if(task.type === 'long') {
                    const statusSel = document.getElementById(`status-${task.id}`);
                    const monthSel = document.getElementById(`month-${task.id}`);
                    
                    const updateData = () => {
                        const s = statusSel.value;
                        const m = monthSel.value;
                        taskEvidents[task.id].status = s;
                        taskEvidents[task.id].month = m;
                        
                        if (s !== 'sudah' && taskEvidents[task.id].image) {
                            uploadedSignatures.delete(taskEvidents[task.id].image.signature);
                            delete taskEvidents[task.id].image;
                        }
                        renderApp();
                    };

                    if(statusSel) statusSel.addEventListener('change', updateData);
                    if(monthSel) monthSel.addEventListener('change', updateData);
                }
            }));
        }

        // --- 5. FILE UPLOAD & COMPRESSION LOGIC ---
        const globalUploader = document.getElementById('global-uploader');
        let isUploadingForLongPeriod = false;

        function triggerUpload(taskId, isLongPeriod = false) {
            currentTargetTaskId = taskId;
            isUploadingForLongPeriod = isLongPeriod;
            globalUploader.click();
        }

        globalUploader.addEventListener('change', async function(e) {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            const task = findTask(currentTargetTaskId);
            if (!task) return;

            let slotsAvailable = task.type === 'short' ? (task.max - taskEvidents[task.id].length) : 1;

            for (const file of files) {
                if (slotsAvailable <= 0) break;

                const signature = `${file.name}_${file.size}_${file.lastModified}`;
                
                if (uploadedSignatures.has(signature)) {
                    showToast(`File "${file.name}" sudah pernah diupload!`, 'error');
                    continue;
                }

                try {
                    const compressedDataUrl = await compressImage(file);
                    
                    uploadedSignatures.add(signature);
                    
                    if (isUploadingForLongPeriod) {
                        taskEvidents[task.id].image = { signature, dataUrl: compressedDataUrl };
                    } else {
                        taskEvidents[task.id].push({ signature, dataUrl: compressedDataUrl });
                        slotsAvailable--;
                    }
                } catch (err) {
                    console.error("Gagal kompresi file:", err);
                    showToast("Gagal memproses gambar.", "error");
                }
            }

            globalUploader.value = '';
            renderApp();
            showToast("Evident berhasil ditambahkan!", "success");
        });

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_DIMENSION = 1280; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_DIMENSION) {
                                height *= MAX_DIMENSION / width;
                                width = MAX_DIMENSION;
                            }
                        } else {
                            if (height > MAX_DIMENSION) {
                                width *= MAX_DIMENSION / height;
                                height = MAX_DIMENSION;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                    img.onerror = error => reject(error);
                };
                reader.onerror = error => reject(error);
            });
        }

        // --- 6. HELPER FUNCTIONS ---
        function findTask(id) {
            // Cari di kedua list (CMEP maupun HK)
            const allCategories = [...checklistDataCMEP, ...checklistDataHK];
            for (const cat of allCategories) {
                const t = cat.tasks.find(x => x.id === id);
                if (t) return t;
            }
            return null;
        }

        window.removeEvident = function(taskId, index, signature) {
            if (confirm("Hapus evident ini?")) {
                taskEvidents[taskId].splice(index, 1);
                uploadedSignatures.delete(signature); 
                renderApp();
            }
        };

        window.removeLongPeriodImage = function(taskId, signature) {
             if (confirm("Hapus evident ini?")) {
                delete taskEvidents[taskId].image;
                uploadedSignatures.delete(signature);
                renderApp();
             }
        }

        let toastTimeout;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toast-icon');
            const msg = document.getElementById('toast-msg');

            msg.innerText = message;
            
            if (type === 'error') {
                toast.classList.replace('bg-gray-800', 'bg-red-600');
                icon.className = 'fas fa-exclamation-triangle mr-2 text-white';
            } else {
                toast.classList.replace('bg-red-600', 'bg-gray-800');
                icon.className = 'fas fa-check-circle mr-2 text-green-400';
            }

            toast.classList.remove('translate-y-20', 'opacity-0');
            
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // Initialization
        updatePrintHeader(); // Ini juga memanggil renderApp() pertama kali

    </script>
</body>
</html>
